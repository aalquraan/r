<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>خطة رانيا للدراسة – وضع الفاينل (التحفيز الفائق ++)</title>
  <style>
    :root{
      --bg:#0b1020; --panel:#0f172a; --card:rgba(255,255,255,.06);
      --border:rgba(255,255,255,.12); --text:#e5e7eb; --muted:#a7b0c0;
      --accent:#7c99ff; --accent2:#9b7cff; --good:#22c55e; --warn:#f59e0b; --bad:#ef4444
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:
      radial-gradient(120% 120% at 80% 0%, #1a2346 0%, #0b1020 60%),
      linear-gradient(135deg, rgba(124,153,255,.10), rgba(155,124,255,.10));
      color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Noto Kufi Arabic","Noto Sans Arabic"}

    .wrap{max-width:1100px;margin:24px auto;padding:0 14px;display:grid;gap:16px}

    /* HEADER */
    header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg, rgba(11,16,32,.9), rgba(11,16,32,.6) 40%, transparent);backdrop-filter:blur(8px);border-bottom:1px solid var(--border)}
    .hero{padding:14px 0 8px}
    .title{display:flex;align-items:center;gap:10px}
    .dot{width:12px;height:12px;border-radius:50%;background:conic-gradient(from 0deg, var(--accent), var(--accent2));box-shadow:0 0 18px var(--accent)}
    h1{margin:0;font-size:clamp(20px,2.6vw,34px)}
    p.lead{margin:6px 0 0;color:var(--muted)}

    .banner{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:12px;background:rgba(245,158,11,.12);border:1px solid rgba(245,158,11,.35)}
    .banner strong{color:#ffd279}

    /* GRID */
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:14px}
    .col-12{grid-column:1/-1}.col-8{grid-column:span 8}.col-4{grid-column:span 4}
    @media (max-width: 980px){.col-8,.col-4{grid-column:1/-1}}

    /* CARDS */
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;overflow:hidden}
    .card .head{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--border)}
    .card .content{padding:14px}

    /* FORM */
    label{display:block;margin:.25rem 0 .3rem;font-weight:700}
    input,textarea,select{width:100%;padding:.75rem 1rem;border-radius:12px;border:1px solid var(--border);background:rgba(255,255,255,.03);color:var(--text)}
    textarea{min-height:120px}
    .row{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    @media (max-width: 760px){.row{grid-template-columns:1fr}}

    /* BUTTONS */
    .btn{cursor:pointer;border:1px solid var(--border);background:rgba(255,255,255,.04);color:var(--text);padding:.7rem 1rem;border-radius:12px;font-weight:800;transition:transform .12s ease, box-shadow .2s ease}
    .btn.primary{background:linear-gradient(135deg, rgba(124,153,255,.35), rgba(155,124,255,.25));border-color:rgba(124,153,255,.5)}
    .btn.good{background:linear-gradient(135deg, rgba(34,197,94,.25), rgba(124,153,255,.2));border-color:rgba(34,197,94,.45)}
    .btn.warn{background:linear-gradient(135deg, rgba(239,68,68,.25), rgba(245,158,11,.2));border-color:rgba(239,68,68,.45)}
    .btn:active{transform:translateY(1px)}

    /* TODAY LIST */
    .list{display:grid;gap:10px}
    .task{display:flex;align-items:center;justify-content:space-between;padding:10px;border:1px solid var(--border);border-radius:12px;background:rgba(255,255,255,.03);position:relative;overflow:hidden}
    .task .left{display:flex;align-items:center;gap:9px}
    .task input[type="checkbox"]{width:18px;height:18px}

    /* TIMELINE */
    .timeline{display:grid;gap:8px}
    .slot{display:grid;grid-template-columns:90px 1fr 130px;gap:10px;align-items:center;padding:8px;border:1px dashed rgba(255,255,255,.16);border-radius:12px}
    .muted{color:var(--muted)}

    /* PROGRESS RING */
    .ring{position:relative;display:grid;place-items:center}
    .ring svg{width:120px;height:120px;transform:rotate(-90deg)}
    .ring .val{position:absolute;text-align:center;font:900 18px/1 ui-sans-serif}

    /* TOAST */
    .toast{position:fixed;bottom:18px;inset-inline:0;margin-inline:auto;width:fit-content;background:rgba(124,153,255,.18);border:1px solid rgba(124,153,255,.45);padding:.55rem .9rem;border-radius:999px;color:#cfe0ff;backdrop-filter:blur(8px);font-weight:800;opacity:0;transform:translateY(8px);transition:all .25s ease}
    .toast.show{opacity:1;transform:none}

    /* OVERLAY */
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);backdrop-filter:blur(3px);display:none;place-items:center;z-index:40}
    .overlay .box{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:16px;text-align:center;max-width:520px}

    /* CELEBRATION */
    .celebrate{position:fixed;inset:0;display:none;place-items:center;z-index:60;pointer-events:none}
    .celebrate.show{display:grid}
    .wow{font:900 clamp(36px,10vw,120px)/1 ui-sans-serif;letter-spacing:3px;background:linear-gradient(90deg,var(--accent),var(--accent2));-webkit-background-clip:text;background-clip:text;color:transparent;filter:drop-shadow(0 8px 24px rgba(124,153,255,.4));animation:wowPop .9s ease;text-align:center}
    @keyframes wowPop{0%{transform:scale(.6) rotate(-2deg);opacity:.2}60%{transform:scale(1.08)}100%{transform:scale(1);opacity:1}}
    .confetti{position:fixed;inset:0;overflow:hidden;z-index:55;pointer-events:none}
    .piece{position:absolute;width:10px;height:18px;background:linear-gradient(180deg,var(--accent),var(--accent2));opacity:.9;border-radius:3px;animation:fall 1.6s ease-out forwards}
    @keyframes fall{to{transform:translateY(120vh) rotate(540deg);opacity:0}}

    .spark{position:absolute;width:6px;height:6px;border-radius:50%;background:linear-gradient(90deg,var(--accent),var(--accent2));filter:drop-shadow(0 0 8px rgba(124,153,255,.8));pointer-events:none}

    /* emoji rain */
    .emoji{position:fixed;font-size:32px;pointer-events:none;animation:drop 1.6s ease forwards;z-index:59}
    @keyframes drop{0%{transform:translateY(-80px)}100%{transform:translateY(120vh);opacity:0}}
  </style>
</head>
<body>
  <header>
    <div class="wrap hero">
      <div class="title"><span class="dot"></span><h1>خطة رانيا للدراسة – وضع الفاينل</h1></div>
      <p class="lead">قسّمي اليوم إلى جلسات واضحة، وسجّلي أهم النقاط—ببساطة وبعيدًا عن المشتتات.</p>
      <div class="banner" role="note" aria-live="polite">
        <span>⚠️</span>
        <div>
          <strong>تنبيه مهم:</strong> عدم الالتزام بالجدول ينقلكِ إلى <strong>صفحة العقاب</strong> 😈، والالتزام الكامل وختم المادة ضمن الوقت ينقلكِ إلى <strong>صفحة الجائزة</strong> 🎁.
        </div>
      </div>
    </div>
  </header>

  <main class="wrap">
    <section class="grid">
      <!-- BUILDER -->
      <div class="card col-12">
        <div class="head"><strong>🔮 ابني خطة اليوم بسرعة</strong><small class="muted">كل شيء محفوظ تلقائيًا</small></div>
        <div class="content">
          <div class="row">
            <div>
              <label for="total">عدد التشابترات</label>
              <input id="total" type="number" min="1" placeholder="مثال: 10" />
            </div>
            <div>
              <label for="hours">الساعات المتاحة اليوم</label>
              <input id="hours" type="number" min="1" step="0.5" value="6" />
            </div>
            <div>
              <label for="exam">وقت الامتحان (اختياري)</label>
              <input id="exam" type="datetime-local" />
            </div>
          </div>
          <div class="row" style="grid-template-columns:repeat(4,1fr);margin-top:10px">
            <div>
              <label for="focusMin">جلسة التركيز (دقيقة)</label>
              <input id="focusMin" type="number" min="15" value="25" />
            </div>
            <div>
              <label for="breakMin">راحة (دقيقة)</label>
              <input id="breakMin" type="number" min="3" value="5" />
            </div>
            <div style="display:flex;align-items:flex-end"><button id="build" class="btn primary" style="width:100%">🚀 ابني الخطة</button></div>
            <div style="display:flex;align-items:flex-end"><button id="clear" class="btn warn" style="width:100%">🧹 حذف</button></div>
          </div>
        </div>
      </div>

      <!-- TODAY / TIMELINE -->
      <div class="card col-8">
        <div class="head"><strong>📅 مهام اليوم</strong><small class="muted">قراءة → ملخص → أسئلة</small></div>
        <div id="today" class="content"><p class="muted">ابني الخطة ليظهر جدول اليوم.</p></div>
      </div>
      <div class="card col-4">
        <div class="head"><strong>⌛ الخط الزمني</strong><small class="muted">يتولد تلقائيًا</small></div>
        <div id="timeline" class="content"><p class="muted">سيظهر هنا جدول الجلسات والراحات.</p></div>
      </div>

      <!-- NOTES / FOCUS / PROGRESS -->
      <div class="card col-8">
        <div class="head"><strong>✍️ أهم النقاط للمراجعة</strong><small class="muted">اكتبي أهم الأفكار أو القوانين</small></div>
        <div class="content">
          <textarea id="notes" placeholder="أضيفي النقاط المهمة خلال الدراسة..."></textarea>
          <div style="display:flex;gap:10px;margin-top:10px">
            <button id="saveNotes" class="btn good">💾 حفظ الملاحظات</button>
            <button id="exportNotes" class="btn">⬇️ تصدير النقاط</button>
            <button id="clearNotes" class="btn warn">🗑️ مسح</button>
          </div>
        </div>
      </div>
      <div class="card col-4">
        <div class="head"><strong>🎧 جلسة التركيز</strong><small class="muted">وضع خالٍ من المشتتات</small></div>
        <div class="content">
          <div class="ring" style="margin-bottom:8px">
            <svg viewBox="0 0 120 120"><circle cx="60" cy="60" r="52" stroke="rgba(255,255,255,.15)" stroke-width="12" fill="none"/><circle id="ring" cx="60" cy="60" r="52" stroke="url(#g)" stroke-width="12" stroke-linecap="round" fill="none" stroke-dasharray="327" stroke-dashoffset="327"/></svg>
            <div class="val"><span id="pct">0%</span></div>
            <svg width="0" height="0"><defs><linearGradient id="g"><stop offset="0%" stop-color="var(--accent)"/><stop offset="100%" stop-color="var(--accent2)"/></linearGradient></defs></svg>
          </div>
          <button id="startFocus" class="btn" style="width:100%">▶️ ابدئي جلسة</button>
          <button id="stopFocus" class="btn warn" style="width:100%;margin-top:8px">⏹️ إيقاف</button>
          <p id="focusLabel" class="muted" style="margin:10px 0 0">00:00</p>
        </div>
      </div>
    </section>
  </main>

  <!-- OVERLAY (DISTRACTION BLOCKER) -->
  <section id="overlay" class="overlay" aria-hidden="true">
    <div class="box">
      <h3 style="margin:0 0 6px">جلسة تركيز قيد التشغيل 🎧</h3>
      <p class="muted">بنقفل الشاشة على خفيف. استخدمي زر الطوارئ لإيقاف الجلسة.</p>
      <button id="panic" class="btn warn" style="margin-top:10px">إيقاف الطوارئ</button>
    </div>
  </section>

  <!-- CELEBRATION LAYER -->
  <div id="celebrate" class="celebrate"><div id="wow" class="wow">وااااااااو 🎉</div></div>
  <div id="confetti" class="confetti" aria-hidden="true"></div>

  <div id="toast" class="toast" role="status" aria-live="polite">تم</div>

  <script>
    const $ = (id)=>document.getElementById(id);
    const el={total:$("total"), hours:$("hours"), exam:$("exam"), focusMin:$("focusMin"), breakMin:$("breakMin"), build:$("build"), clear:$("clear"), today:$("today"), timeline:$("timeline"), notes:$("notes"), saveNotes:$("saveNotes"), exportNotes:$("exportNotes"), clearNotes:$("clearNotes"), startFocus:$("startFocus"), stopFocus:$("stopFocus"), focusLabel:$("focusLabel"), overlay:$("overlay"), panic:$("panic"), pct:$("pct"), ring:document.getElementById("ring"), toast:$("toast"), celebrate:$("celebrate"), confetti:$("confetti"), wow:$("wow")};

    // STORAGE & HELPERS
    const SKEY='rania_final_plan_v6', SKEY_NOTES='rania_final_notes_v6', SKEY_FORM='rania_final_form_v5';
    function toast(msg){ el.toast.textContent=msg; el.toast.classList.add('show'); setTimeout(()=>el.toast.classList.remove('show'),1400); }
    function savePlan(p){ localStorage.setItem(SKEY, JSON.stringify(p)); toast('تم حفظ الخطة ✅'); }
    function loadPlan(){ try{return JSON.parse(localStorage.getItem(SKEY))||null}catch{return null} }
    function saveForm(){ const f={total:el.total.value, hours:el.hours.value, exam:el.exam.value, focusMin:el.focusMin.value, breakMin:el.breakMin.value}; localStorage.setItem(SKEY_FORM, JSON.stringify(f)); }
    function loadForm(){ try{ const f=JSON.parse(localStorage.getItem(SKEY_FORM)||'{}'); Object.entries(f).forEach(([k,v])=>{ if(v!==undefined && el[k]) el[k].value=v; }); }catch{} }
    ;['total','hours','exam','focusMin','breakMin'].forEach(id=>$(id).addEventListener('change', saveForm));

    const timeStr=(d)=> String(d.getHours()).padStart(2,'0')+':'+String(d.getMinutes()).padStart(2,'0');
    const pick=(arr)=> arr[Math.floor(Math.random()*arr.length)];

    // Praise & motivation pools
    const PRAISE=[
      'وااااااااو! شغل بطلة! 🏆',
      'يا سلام! إبداعك لا يوصف ✨',
      'ممتاز يا رانيا! استمري 👑',
      'يا نجمة! خطوة أقرب للنجاح 🌟',
      'عظمة على عظمة! 🔥',
      'هيك الشغل الصح! 🙌',
      'أحسنتِ! تقدّم ملحوظ 💪',
      'رهااابة! كمّلي على نفس النسق 🚀'
    ];
    const MINI=['برافو!','تمام!','هيك!','يس!','تفاتيف ذهب!','يا عيني!'];
    const EMOJIS=['🎉','✨','💥','🔥','🌟','🏆','💫','🪄','🎊','🥳'];
    const MOTIV=[
      '10 دقايق راحت! كمّلي يا بطلة! 💪',
      'خمس صفحات زيادة بتفرق كثير! 📚',
      'شهيق… زفير… ونكمل! 🌬️',
      'ركّزي دقيقتين بس… وبعدين الباقي سهل ✨',
      'الاستمرارية أقوى من الكمال. مشّيها! 🚶‍♀️',
      'كل تِك عليها تقرّبك لهدفك 🎯'
    ];

    // Audio & speech
    let actx; function ping(){ try{ actx=actx||new (window.AudioContext||window.webkitAudioContext)(); const o=actx.createOscillator(); const g=actx.createGain(); o.type='triangle'; o.frequency.value=880; g.gain.value=.001; o.connect(g); g.connect(actx.destination); o.start(); g.gain.exponentialRampToValueAtTime(.00001, actx.currentTime+0.25); o.stop(actx.currentTime+0.26);}catch{} }
    function clap(){ try{ actx=actx||new (window.AudioContext||window.webkitAudioContext)(); const buf=actx.createBuffer(1, actx.sampleRate*0.25, actx.sampleRate); const data=buf.getChannelData(0); for(let i=0;i<data.length;i++){ data[i]=(Math.random()*2-1)*Math.pow(1-i/data.length,2); } const src=actx.createBufferSource(); src.buffer=buf; src.connect(actx.destination); src.start(); }catch{} }
    function speak(text){ try{ const u=new SpeechSynthesisUtterance(text); u.lang='ar-JO'; u.rate=1; u.pitch=1; speechSynthesis.cancel(); speechSynthesis.speak(u); }catch{} }

    // Confetti, emoji rain & fireworks
    function burstWith(text){ el.wow.innerHTML = text; el.celebrate.classList.add('show');
      const n=240; el.confetti.innerHTML=''; const vw=window.innerWidth;
      for(let i=0;i<n;i++){ const p=document.createElement('div'); p.className='piece'; const x=Math.random()*vw; const delay=Math.random()*400; const scale=.5+Math.random()*1.6; p.style.left=x+'px'; p.style.top='-20px'; p.style.transform=`translateY(0) scale(${scale}) rotate(${Math.random()*360}deg)`; p.style.animationDelay=delay+'ms'; el.confetti.appendChild(p); }
      setTimeout(()=>{ el.celebrate.classList.remove('show'); el.confetti.innerHTML=''; }, 2200);
    }
    function emojiRain(){ const n=40; const vw=innerWidth; for(let i=0;i<n;i++){ const e=document.createElement('div'); e.className='emoji'; e.textContent=pick(EMOJIS); e.style.left=(Math.random()*vw)+'px'; e.style.top='-40px'; e.style.fontSize=(26+Math.random()*22)+'px'; e.style.transform=`rotate(${Math.random()*40-20}deg)`; document.body.appendChild(e); setTimeout(()=>e.remove(),1600); }
    }
    let fw; (function setupFW(){ fw=document.createElement('canvas'); fw.width=innerWidth; fw.height=innerHeight; fw.style.cssText='position:fixed;inset:0;pointer-events:none;z-index:58;'; document.body.appendChild(fw); window.addEventListener('resize',()=>{fw.width=innerWidth; fw.height=innerHeight}); })();
    function fireworks(){ const c=fw.getContext('2d'); const parts=[]; const cx=Math.random()*fw.width, cy=fw.height*0.3+Math.random()*fw.height*0.3; for(let i=0;i<130;i++){ const a=Math.random()*Math.PI*2, s=Math.random()*3+1; parts.push({x:cx,y:cy,vx:Math.cos(a)*s,vy:Math.sin(a)*s,life:60}); }
      let t=0; function anim(){ c.clearRect(0,0,fw.width,fw.height); parts.forEach(p=>{ p.x+=p.vx; p.y+=p.vy; p.vy+=0.02; p.life--; c.fillStyle='rgba(124,153,255,'+(p.life/60)+')'; c.fillRect(p.x,p.y,2,2); }); if(t++<60) requestAnimationFrame(anim); else c.clearRect(0,0,fw.width,fw.height); } anim(); }
    function miniSparkle(target){ const n=22; const r=target.getBoundingClientRect(); const x=r.left+r.width/2, y=r.top+r.height/2; for(let i=0;i<n;i++){ const s=document.createElement('div'); s.className='spark'; document.body.appendChild(s); const a=Math.random()*Math.PI*2, d=10+Math.random()*60; const tx=x+Math.cos(a)*d, ty=y+Math.sin(a)*d; s.style.left=x+'px'; s.style.top=y+'px'; s.animate([{transform:'translate(0,0)',opacity:1},{transform:`translate(${tx-x}px,${ty-y}px)`,opacity:0}],{duration:700,fill:'forwards'}).onfinish=()=>s.remove(); }
    }

    function celebrate(){ const msg = pick(PRAISE); toast(msg); clap(); ping(); speak(msg); burstWith(`${msg} ${pick(EMOJIS)}`); emojiRain(); fireworks(); }

    // PLAN BUILD (even distribution)
    function build(){
      const total=+el.total.value||0, hours=+el.hours.value||0; if(!total||!hours){ alert('رجاءً أدخلي عدد التشابترات والساعات المتاحة'); return }
      const now=new Date();
      const exam=el.exam.value? new Date(el.exam.value): null;
      if(exam && exam<=now){ alert('وقت الامتحان أقدم من الآن. عدلي الوقت أو اتركيه فارغًا.'); return }
      const hardEnd = new Date(now.getTime()+hours*3600000);
      const end = exam? new Date(Math.min(hardEnd.getTime(), exam.getTime())) : hardEnd;
      const f=+el.focusMin.value||25, b=+el.breakMin.value||5; const block=f+b;
      const totalMin=Math.max(0,Math.floor((end-now)/60000));
      if(totalMin < f){ alert('الوقت المتاح أقل من مدة جلسة التركيز. زيدي الوقت أو قللي مدة الجلسة.'); return }
      const slots=Math.max(1,Math.floor(totalMin/block));
      const chaptersPerSlot = Math.ceil(total / slots);

      const tasks=[]; const slotsArr=[]; let coveredCh=0; let cursor=new Date(now);
      for(let s=0; s<slots && coveredCh<total; s++){
        const start=new Date(cursor), endFocus=new Date(cursor.getTime()+f*60000), afterBreak=new Date(endFocus.getTime()+b*60000);
        const startChap=coveredCh+1; const endChap=Math.min(total, coveredCh+chaptersPerSlot);
        const rangeLabel = (startChap===endChap)? `تش ${startChap}` : `تش ${startChap}–${endChap}`;
        slotsArr.push({start: timeStr(start), end: timeStr(endFocus), label: rangeLabel});
        for(let ch=startChap; ch<=endChap; ch++){
          const win=`${timeStr(start)}–${timeStr(endFocus)}`;
          tasks.push({title:`${win} | تش ${ch}: قراءة`, done:false});
          tasks.push({title:`${win} | تش ${ch}: ملخص`, done:false});
          tasks.push({title:`${win} | تش ${ch}: أسئلة`, done:false});
        }
        coveredCh = endChap; cursor = afterBreak;
      }

      const plan={meta:{total,hours,focus:f,break:b,exam:exam?exam.toISOString():null, slots:slotsArr}, tasks};
      savePlan(plan); render(plan);
      if('Notification' in window && Notification.permission!=='granted'){ Notification.requestPermission?.(); }
    }

    function render(plan){
      el.today.innerHTML=''; const list=document.createElement('div'); list.className='list';
      plan.tasks.forEach((t,i)=>{
        const row=document.createElement('div'); row.className='task';
        const left=document.createElement('label'); left.className='left'; left.setAttribute('aria-label', t.title);
        const cb=document.createElement('input'); cb.type='checkbox'; cb.checked=t.done; cb.disabled=t.done; cb.addEventListener('change',()=>{ t.done=true; cb.disabled=true; savePlan(plan); updateProgress(plan); navigator.vibrate?.(25); celebrate(); miniSparkle(row); checkEndgame(plan); });
        const span=document.createElement('span'); span.textContent=t.title; left.append(cb,span);
        const del=document.createElement('button'); del.className='btn warn'; del.textContent='حذف'; del.addEventListener('click',()=>{ plan.tasks.splice(i,1); savePlan(plan); render(plan); toast(pick(MINI)); });
        if(t.done){ row.style.opacity=.78; row.style.filter='grayscale(18%)'; span.style.textDecoration='line-through'; }
        row.append(left,del); list.append(row);
      }); el.today.append(list);

      el.timeline.innerHTML=''; const tl=document.createElement('div'); tl.className='timeline';
      (plan.meta.slots||[]).forEach(s=>{ const slot=document.createElement('div'); slot.className='slot'; const t1=document.createElement('div'); t1.textContent=`${s.start}–${s.end}`; const t2=document.createElement('div'); t2.textContent=s.label; const t3=document.createElement('div'); t3.className='muted'; t3.textContent='راحة + ماء'; slot.append(t1,t2,t3); tl.append(slot); });
      if(!plan.meta.slots || plan.meta.slots.length===0){ tl.innerHTML = '<p class="muted">لا يوجد شريط زمني بعد.</p>'; }
      el.timeline.append(tl);

      updateProgress(plan);
    }

    function updateProgress(plan){ const total=plan.meta.total||0; if(!total){ el.pct.textContent='0%'; el.ring.style.strokeDashoffset = 327; return }
      const doneTasks = plan.tasks.filter(t=>t.done && /قراءة|ملخص|أسئلة/.test(t.title)).length; const doneChapters = doneTasks/3; const pct = Math.min(100, Math.round((doneChapters/total)*100)); el.pct.textContent=pct+'%'; el.ring.style.strokeDashoffset = 327*(1-pct/100); }

    function checkEndgame(plan){
      const total=plan.meta.total; const done = plan.tasks.filter(t=>t.done && /قراءة|ملخص|أسئلة/.test(t.title)).length/3;
      const allDone = total>0 && done>=total;
      if(allDone){ setTimeout(()=>{ location.href='الجائزة.html?total='+total; }, 600); return }
      const exam=plan.meta.exam? new Date(plan.meta.exam): null; if(exam){ const left = exam - new Date(); if(left<=0 && done<total){ location.href = 'العقاب.html?total='+total+'&done='+Math.floor(done); } }
    }

    // Focus timers
    let timer=null; let remain=0; let running=false; let onBreak=false;
    const fmt=(s)=>{ const m=Math.floor(s/60), S=s%60; return String(m).padStart(2,'0')+':'+String(S).padStart(2,'0') };
    function clearTimer(){ if(timer){ clearInterval(timer); timer=null; } }
    function startFocus(){ if(running) return; const f=+(el.focusMin.value||25), b=+(el.breakMin.value||5); remain=f*60; running=true; onBreak=false; el.overlay.style.display='grid'; try{ document.documentElement.requestFullscreen?.(); }catch{}
      tick(); clearTimer(); timer=setInterval(()=>{ remain--; tick(); if(remain<=0){ clearTimer(); running=false; if(!onBreak){ speak('وقت راحة خمس دقائق. أحسنتِ!'); onBreak=true; remain=b*60; timer=setInterval(()=>{ remain--; tick(); if(remain<=0){ clearTimer(); running=false; el.overlay.style.display='none'; document.exitFullscreen?.(); speak('الراحة خلصت، لنبدأ جلسة جديدة.'); } },1000); } } },1000); }
    function stopFocus(){ clearTimer(); running=false; el.overlay.style.display='none'; document.exitFullscreen?.(); el.focusLabel.textContent='00:00'; }
    function tick(){ el.focusLabel.textContent = fmt(remain) }

    // Notes
    function loadNotes(){ try{return localStorage.getItem(SKEY_NOTES)||''}catch{return ''} }
    function saveNotes(){ localStorage.setItem(SKEY_NOTES, el.notes.value); toast('تم حفظ الملاحظات ✅') }
    function exportNotes(){ const blob=new Blob([el.notes.value||''],{type:'text/plain'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='rania_notes.txt'; a.click(); URL.revokeObjectURL(url); }

    // Timers: taunt (30m) + motivation (10m)
    let tauntTimer=null, motTimer=null;
    function setupTaunt(){ if(tauntTimer) clearInterval(tauntTimer); tauntTimer=setInterval(()=>{ speak('شكلك مش راح تكمّلي على الوقت زي ما كنت متوقع، هاهاها! يلا شدّي حالك!'); }, 30*60*1000); }
    function setupMotivation(){ if(motTimer) clearInterval(motTimer); motTimer=setInterval(()=>{ const m=pick(MOTIV); toast(m); speak(m); ping(); }, 10*60*1000); }

    // Events
    el.build.addEventListener('click', build);
    el.clear.addEventListener('click', ()=>{ localStorage.removeItem(SKEY); el.today.innerHTML='<p class="muted">ابني الخطة ليظهر جدول اليوم.</p>'; el.timeline.innerHTML='<p class="muted">سيظهر هنا جدول الجلسات والراحات.</p>'; updateProgress({meta:{total:0},tasks:[]}); });
    el.startFocus.addEventListener('click', startFocus); el.stopFocus.addEventListener('click', stopFocus); el.panic.addEventListener('click', stopFocus);
    el.saveNotes.addEventListener('click', saveNotes); el.exportNotes.addEventListener('click', exportNotes); el.clearNotes.addEventListener('click', ()=>{ el.notes.value=''; saveNotes(); });

    // INIT
    (function init(){ loadForm(); const plan=loadPlan(); if(plan){ render(plan); } el.notes.value = loadNotes(); updateProgress(plan||{meta:{total:0},tasks:[]}); setupTaunt(); setupMotivation(); })();
  </script>
</body>
</html>
