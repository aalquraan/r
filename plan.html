<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>خطة رانيا للدراسة – وضع الفاينل</title>
  <style>
    :root{
      --bg:#0b1020; --panel:#0f172a; --card:rgba(255,255,255,.06);
      --border:rgba(255,255,255,.12); --text:#e5e7eb; --muted:#a7b0c0;
      --accent:#7c99ff; --accent2:#9b7cff; --good:#22c55e; --warn:#f59e0b; --bad:#ef4444
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:
      radial-gradient(120% 120% at 80% 0%, #1a2346 0%, #0b1020 60%),
      linear-gradient(135deg, rgba(124,153,255,.10), rgba(155,124,255,.10));
      color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Noto Kufi Arabic","Noto Sans Arabic"}

    .wrap{max-width:1100px;margin:24px auto;padding:0 14px;display:grid;gap:16px}

    /* HEADER */
    header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg, rgba(11,16,32,.9), rgba(11,16,32,.6) 40%, transparent);backdrop-filter:blur(8px);border-bottom:1px solid var(--border)}
    .hero{padding:14px 0 8px}
    .title{display:flex;align-items:center;gap:10px}
    .dot{width:12px;height:12px;border-radius:50%;background:conic-gradient(from 0deg, var(--accent), var(--accent2));box-shadow:0 0 18px var(--accent)}
    h1{margin:0;font-size:clamp(20px,2.6vw,34px)}
    p.lead{margin:6px 0 0;color:var(--muted)}

    .banner{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:12px;background:rgba(245,158,11,.12);border:1px solid rgba(245,158,11,.35)}
    .banner strong{color:#ffd279}

    /* GRID */
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:14px}
    .col-12{grid-column:1/-1}.col-8{grid-column:span 8}.col-4{grid-column:span 4}
    @media (max-width: 980px){.col-8,.col-4{grid-column:1/-1}}

    /* CARDS */
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;overflow:hidden}
    .card .head{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--border)}
    .card .content{padding:14px}

    /* FORM */
    label{display:block;margin:.25rem 0 .3rem;font-weight:700}
    input,textarea,select{width:100%;padding:.75rem 1rem;border-radius:12px;border:1px solid var(--border);background:rgba(255,255,255,.03);color:var(--text)}
    textarea{min-height:120px}
    .row{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    @media (max-width: 760px){.row{grid-template-columns:1fr}}

    /* BUTTONS */
    .btn{cursor:pointer;border:1px solid var(--border);background:rgba(255,255,255,.04);color:var(--text);padding:.7rem 1rem;border-radius:12px;font-weight:800;transition:transform .12s ease, box-shadow .2s ease}
    .btn.primary{background:linear-gradient(135deg, rgba(124,153,255,.35), rgba(155,124,255,.25));border-color:rgba(124,153,255,.5)}
    .btn.good{background:linear-gradient(135deg, rgba(34,197,94,.25), rgba(124,153,255,.2));border-color:rgba(34,197,94,.45)}
    .btn.warn{background:linear-gradient(135deg, rgba(239,68,68,.25), rgba(245,158,11,.2));border-color:rgba(239,68,68,.45)}
    .btn:active{transform:translateY(1px)}

    /* TODAY LIST */
    .list{display:grid;gap:10px}
    .task{display:flex;align-items:center;justify-content:space-between;padding:10px;border:1px solid var(--border);border-radius:12px;background:rgba(255,255,255,.03)}
    .task .left{display:flex;align-items:center;gap:9px}
    .task input[type="checkbox"]{width:18px;height:18px}

    /* TIMELINE */
    .timeline{display:grid;gap:8px}
    .slot{display:grid;grid-template-columns:90px 1fr 130px;gap:10px;align-items:center;padding:8px;border:1px dashed rgba(255,255,255,.16);border-radius:12px}
    .muted{color:var(--muted)}

    /* PROGRESS RING */
    .ring{position:relative;display:grid;place-items:center}
    .ring svg{width:120px;height:120px;transform:rotate(-90deg)}
    .ring .val{position:absolute;text-align:center;font:900 18px/1 ui-sans-serif}

    /* TOAST */
    .toast{position:fixed;bottom:18px;inset-inline:0;margin-inline:auto;width:fit-content;background:rgba(124,153,255,.18);border:1px solid rgba(124,153,255,.45);padding:.55rem .9rem;border-radius:999px;color:#cfe0ff;backdrop-filter:blur(8px);font-weight:800;opacity:0;transform:translateY(8px);transition:all .25s ease}
    .toast.show{opacity:1;transform:none}

    /* OVERLAY */
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);backdrop-filter:blur(3px);display:none;place-items:center;z-index:40}
    .overlay .box{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:16px;text-align:center;max-width:520px}
  </style>
</head>
<body>
  <header>
    <div class="wrap hero">
      <div class="title"><span class="dot"></span><h1>خطة رانيا للدراسة – وضع الفاينل</h1></div>
      <p class="lead">قسّمي اليوم إلى جلسات واضحة، وسجّلي أهم النقاط—ببساطة وبعيدًا عن المشتتات.</p>
      <div class="banner" role="note" aria-live="polite">
        <span>⚠️</span>
        <div>
          <strong>تنبيه مهم:</strong> عدم الالتزام بالجدول ينقلكِ إلى <strong>صفحة العقاب</strong> 😈، والالتزام الكامل وختم المادة ضمن الوقت ينقلكِ إلى <strong>صفحة الجائزة</strong> 🎁.
        </div>
      </div>
    </div>
  </header>

  <main class="wrap">
    <section class="grid">
      <!-- BUILDER -->
      <div class="card col-12">
        <div class="head"><strong>🔮 ابني خطة اليوم بسرعة</strong><small class="muted">كل شيء محفوظ تلقائيًا</small></div>
        <div class="content">
          <div class="row">
            <div>
              <label>عدد التشابترات</label>
              <input id="total" type="number" min="1" placeholder="مثال: 10" />
            </div>
            <div>
              <label>الساعات المتاحة اليوم</label>
              <input id="hours" type="number" min="1" step="0.5" value="6" />
            </div>
            <div>
              <label>وقت الامتحان (اختياري)</label>
              <input id="exam" type="datetime-local" />
            </div>
          </div>
          <div class="row" style="grid-template-columns:repeat(4,1fr);margin-top:10px">
            <div>
              <label>جلسة التركيز (دقيقة)</label>
              <input id="focusMin" type="number" min="15" value="25" />
            </div>
            <div>
              <label>راحة (دقيقة)</label>
              <input id="breakMin" type="number" min="3" value="5" />
            </div>
            <div style="display:flex;align-items:flex-end"><button id="build" class="btn primary" style="width:100%">🚀 ابني الخطة</button></div>
            <div style="display:flex;align-items:flex-end"><button id="clear" class="btn warn" style="width:100%">🧹 حذف</button></div>
          </div>
        </div>
      </div>

      <!-- TODAY / TIMELINE -->
      <div class="card col-8">
        <div class="head"><strong>📅 مهام اليوم</strong><small class="muted">قراءة → ملخص → أسئلة</small></div>
        <div id="today" class="content"><p class="muted">ابني الخطة ليظهر جدول اليوم.</p></div>
      </div>
      <div class="card col-4">
        <div class="head"><strong>⌛ الخط الزمني</strong><small class="muted">يتولد تلقائيًا</small></div>
        <div id="timeline" class="content"><p class="muted">سيظهر هنا جدول الجلسات والراحات.</p></div>
      </div>

      <!-- NOTES / FOCUS / PROGRESS -->
      <div class="card col-8">
        <div class="head"><strong>✍️ أهم النقاط للمراجعة</strong><small class="muted">اكتبي أهم الأفكار أو القوانين</small></div>
        <div class="content">
          <textarea id="notes" placeholder="أضيفي النقاط المهمة خلال الدراسة..."></textarea>
          <div style="display:flex;gap:10px;margin-top:10px">
            <button id="saveNotes" class="btn good">💾 حفظ الملاحظات</button>
            <button id="exportNotes" class="btn">⬇️ تصدير النقاط</button>
            <button id="clearNotes" class="btn warn">🗑️ مسح</button>
          </div>
        </div>
      </div>
      <div class="card col-4">
        <div class="head"><strong>🎧 جلسة التركيز</strong><small class="muted">وضع خالٍ من المشتتات</small></div>
        <div class="content">
          <div class="ring" style="margin-bottom:8px">
            <svg viewBox="0 0 120 120"><circle cx="60" cy="60" r="52" stroke="rgba(255,255,255,.15)" stroke-width="12" fill="none"/><circle id="ring" cx="60" cy="60" r="52" stroke="url(#g)" stroke-width="12" stroke-linecap="round" fill="none" stroke-dasharray="327" stroke-dashoffset="327"/></svg>
            <div class="val"><span id="pct">0%</span></div>
            <svg width="0" height="0"><defs><linearGradient id="g"><stop offset="0%" stop-color="var(--accent)"/><stop offset="100%" stop-color="var(--accent2)"/></linearGradient></defs></svg>
          </div>
          <button id="startFocus" class="btn" style="width:100%">▶️ ابدئي جلسة</button>
          <button id="stopFocus" class="btn warn" style="width:100%;margin-top:8px">⏹️ إيقاف</button>
          <p id="focusLabel" class="muted" style="margin:10px 0 0">00:00</p>
        </div>
      </div>
    </section>
  </main>

  <!-- OVERLAY (DISTRACTION BLOCKER) -->
  <section id="overlay" class="overlay" aria-hidden="true">
    <div class="box">
      <h3 style="margin:0 0 6px">جلسة تركيز قيد التشغيل 🎧</h3>
      <p class="muted">بنقفل الشاشة على خفيف. استخدمي زر الطوارئ لإيقاف الجلسة.</p>
      <button id="panic" class="btn warn" style="margin-top:10px">إيقاف الطوارئ</button>
    </div>
  </section>

  <div id="toast" class="toast" role="status" aria-live="polite">تم</div>

  <script>
    // ELEMENTS
    const $ = (id)=>document.getElementById(id);
    const el={total:$('total'), hours:$('hours'), exam:$('exam'), focusMin:$('focusMin'), breakMin:$('breakMin'), build:$('build'), clear:$('clear'), today:$('today'), timeline:$('timeline'), notes:$('notes'), saveNotes:$('saveNotes'), exportNotes:$('exportNotes'), clearNotes:$('clearNotes'), startFocus:$('startFocus'), stopFocus:$('stopFocus'), focusLabel:$('focusLabel'), overlay:$('overlay'), panic:$('panic'), pct:$('pct'), ring:document.getElementById('ring'), toast:$('toast')};

    // STATE + STORAGE
    const SKEY='rania_final_plan_v1', SKEY_NOTES='rania_final_notes_v1';
    function toast(msg){ el.toast.textContent=msg; el.toast.classList.add('show'); setTimeout(()=>el.toast.classList.remove('show'),1400); }
    function savePlan(p){ localStorage.setItem(SKEY, JSON.stringify(p)); toast('تم حفظ الخطة ✅'); }
    function loadPlan(){ try{return JSON.parse(localStorage.getItem(SKEY))||null}catch{return null} }

    // BUILD PLAN (one-day timeline)
    function timeStr(d){ return String(d.getHours()).padStart(2,'0')+':'+String(d.getMinutes()).padStart(2,'0') }
    function build(){
      const total=+el.total.value||0, hours=+el.hours.value||0; if(!total||!hours){ alert('رجاءً أدخلي عدد التشابترات والساعات المتاحة'); return }
      const now=new Date(); const exam=el.exam.value? new Date(el.exam.value): null; const end = exam? new Date(Math.min(now.getTime()+hours*3600000, exam.getTime())) : new Date(now.getTime()+hours*3600000);
      const f=+el.focusMin.value||25, b=+el.breakMin.value||5; const block=f+b; const totalMin=Math.max(0,Math.floor((end-now)/60000)); const slots=Math.max(1,Math.floor(totalMin/block)); const perSlot=Math.max(0.25,total/slots);
      const tasks=[]; let covered=0; let cursor=new Date(now);
      for(let i=0;i<slots && covered<total;i++){
        const s=new Date(cursor), e=new Date(cursor.getTime()+f*60000), be=new Date(e.getTime()+b*60000);
        const chap=Math.floor(covered)+1;
        tasks.push({title:`${timeStr(s)}–${timeStr(e)} | تش ${chap}: قراءة`, done:false});
        tasks.push({title:`${timeStr(s)}–${timeStr(e)} | تش ${chap}: ملخص`, done:false});
        tasks.push({title:`${timeStr(s)}–${timeStr(e)} | تش ${chap}: أسئلة`, done:false});
        covered+=perSlot; cursor=be;
      }
      const plan={meta:{total,hours,focus:f,break:b,exam:exam?exam.toISOString():null}, tasks}; savePlan(plan); render(plan);
      if('Notification' in window && Notification.permission!=='granted'){ Notification.requestPermission?.(); }
    }

    function render(plan){
      // Today list
      el.today.innerHTML=''; const list=document.createElement('div'); list.className='list';
      plan.tasks.forEach((t,i)=>{
        const row=document.createElement('div'); row.className='task';
        const left=document.createElement('div'); left.className='left'; const cb=document.createElement('input'); cb.type='checkbox'; cb.checked=t.done; cb.addEventListener('change',()=>{ t.done=cb.checked; savePlan(plan); updateProgress(plan); if(cb.checked){ navigator.vibrate?.(15); if('Notification' in window){ new Notification('✔️ تم', { body: t.title }); } } checkEndgame(plan); }); const span=document.createElement('span'); span.textContent=t.title; left.append(cb,span);
        const del=document.createElement('button'); del.className='btn warn'; del.textContent='حذف'; del.addEventListener('click',()=>{ plan.tasks.splice(i,1); savePlan(plan); render(plan); });
        row.append(left,del); list.append(row);
      }); el.today.append(list);

      // Timeline
      el.timeline.innerHTML=''; const tl=document.createElement('div'); tl.className='timeline';
      const chunks = []; // compress by session window
      plan.tasks.forEach(t=>{ const m=t.title.match(/^(\d{2}:\d{2})–(\d{2}:\d{2}) \| (.*)$/); if(!m) return; chunks.push({start:m[1], end:m[2], label:m[3]}); });
      for(let i=0;i<chunks.length;i+=3){
        const start=chunks[i]?.start, end=chunks[i]?.end; const label=(chunks[i]?.label||'جلسة');
        const slot=document.createElement('div'); slot.className='slot';
        const t1=document.createElement('div'); t1.textContent=`${start}–${end}`;
        const t2=document.createElement('div'); t2.textContent=label;
        const t3=document.createElement('div'); t3.className='muted'; t3.textContent='راحة + ماء';
        slot.append(t1,t2,t3); tl.append(slot);
      }
      el.timeline.append(tl);

      updateProgress(plan);
    }

    // PROGRESS RING
    function updateProgress(plan){ const total=plan.meta.total; const done = plan.tasks.filter(t=>t.done && /قراءة|ملخص|أسئلة/.test(t.title)).length/3; const pct = Math.min(100, Math.round((done/total)*100)); el.pct.textContent=pct+'%'; el.ring.style.strokeDashoffset = 327*(1-pct/100); }

    // ENDGAME: punishment or prize
    function checkEndgame(plan){
      const total=plan.meta.total; const done = plan.tasks.filter(t=>t.done && /قراءة|ملخص|أسئلة/.test(t.title)).length/3;
      const allDone = total>0 && done>=total;
      if(allDone){ setTimeout(()=>{ location.href='الجائزة.html?total='+total; }, 600); return }
      const exam=plan.meta.exam? new Date(plan.meta.exam): null; if(exam){
        const left = exam - new Date(); if(left<=0 && done<total){ location.href = 'العقاب.html?total='+total+'&done='+done; }
      }
    }

    // FOCUS SESSION
    let timer=null, remain=0, running=false, onBreak=false;
    function fmt(s){ const m=Math.floor(s/60), S=s%60; return String(m).padStart(2,'0')+':'+String(S).padStart(2,'0') }
    function startFocus(){ if(running) return; const f=+(el.focusMin.value||25), b=+(el.breakMin.value||5); remain=f*60; running=true; onBreak=false; el.overlay.style.display='grid'; try{ document.documentElement.requestFullscreen(); }catch{} tick(); timer=setInterval(()=>{ remain--; tick(); if(remain<=0){ clearInterval(timer); running=false; if(!onBreak){ speak('وقت راحة خمس دقائق. أحسنتِ!'); onBreak=true; remain=b*60; timer=setInterval(()=>{ remain--; tick(); if(remain<=0){ clearInterval(timer); running=false; el.overlay.style.display='none'; document.exitFullscreen?.(); speak('الراحة خلصت، لنبدأ جلسة جديدة.'); } },1000); } } },1000); }
    function stopFocus(){ clearInterval(timer); running=false; el.overlay.style.display='none'; document.exitFullscreen?.(); el.focusLabel.textContent='00:00'; }
    function tick(){ el.focusLabel.textContent = fmt(remain) }
    function speak(text){ try{ const u=new SpeechSynthesisUtterance(text); u.lang='ar-JO'; speechSynthesis.cancel(); speechSynthesis.speak(u); }catch{} }

    // NOTES
    function loadNotes(){ try{return localStorage.getItem(SKEY_NOTES)||''}catch{return ''} }
    function saveNotes(){ localStorage.setItem(SKEY_NOTES, el.notes.value); toast('تم حفظ الملاحظات ✅') }
    function exportNotes(){ const blob=new Blob([el.notes.value||''],{type:'text/plain'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='rania_notes.txt'; a.click(); URL.revokeObjectURL(url); }

    // EVENTS
    el.build.addEventListener('click', build); el.clear.addEventListener('click', ()=>{ localStorage.removeItem(SKEY); el.today.innerHTML='<p class="muted">ابني الخطة ليظهر جدول اليوم.</p>'; el.timeline.innerHTML='<p class="muted">سيظهر هنا جدول الجلسات والراحات.</p>'; updateProgress({meta:{total:0},tasks:[]}); });
    el.startFocus.addEventListener('click', startFocus); el.stopFocus.addEventListener('click', stopFocus); el.panic.addEventListener('click', stopFocus);
    el.saveNotes.addEventListener('click', saveNotes); el.exportNotes.addEventListener('click', exportNotes); el.clearNotes.addEventListener('click', ()=>{ el.notes.value=''; saveNotes(); });

    // INIT
    (function init(){ const plan=loadPlan(); if(plan){ render(plan); } el.notes.value = loadNotes(); updateProgress(plan||{meta:{total:0},tasks:[]}); })();
  </script>
</body>
</html>
